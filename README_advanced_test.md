# FLUX API é«˜çº§ååé‡æµ‹è¯•å·¥å…·

åŸºäºä¼˜åŒ–æ€è·¯çš„é«˜çº§ååé‡æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æµ‹è¯•ä¸åŒä¼˜åŒ–ç­–ç•¥å¯¹æ€§èƒ½çš„å½±å“ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

### 1. **å¤šç­–ç•¥æµ‹è¯•**
- **baseline**: åŸºå‡†æµ‹è¯• (å½“å‰å®ç°)
- **model_pool**: æ¨¡å‹æ± ä¼˜åŒ–æµ‹è¯•
- **batch**: æ‰¹é‡æ¨ç†æµ‹è¯•  
- **async**: å¼‚æ­¥æ¨ç†æµ‹è¯•

### 2. **ç³»ç»Ÿç›‘æ§**
- å®æ—¶ GPU åˆ©ç”¨ç‡ç›‘æ§
- VRAM ä½¿ç”¨æƒ…å†µè·Ÿè¸ª
- CPU å’Œå†…å­˜ä½¿ç”¨ç‡ç›‘æ§
- è‡ªåŠ¨æ•°æ®æ”¶é›†å’Œåˆ†æ

### 3. **æ€§èƒ½åˆ†æ**
- ååé‡å¯¹æ¯”åˆ†æ
- å“åº”æ—¶é—´åˆ†å¸ƒ (P50, P95, P99)
- æ•ˆç‡åˆ†æ•°è®¡ç®—
- èµ„æºåˆ©ç”¨ç‡åˆ†æ

### 4. **å¯è§†åŒ–æŠ¥å‘Š**
- æ€§èƒ½å¯¹æ¯”å›¾è¡¨
- é›·è¾¾å›¾åˆ†æ
- è¯¦ç»†ç»Ÿè®¡æŠ¥å‘Š

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
# åŸºç¡€ä¾èµ–
pip install aiohttp psutil numpy

# å¯é€‰: å›¾è¡¨ç”Ÿæˆ
pip install matplotlib
```

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬æµ‹è¯•
```bash
# æµ‹è¯•åŸºå‡†æ€§èƒ½
python test_throughput_advanced.py --requests 20 --concurrent 3

# æµ‹è¯•æ‰€æœ‰ä¼˜åŒ–ç­–ç•¥
python test_throughput_advanced.py --requests 20 --concurrent 3 --strategies all

# æµ‹è¯•ç‰¹å®šç­–ç•¥
python test_throughput_advanced.py --requests 30 --concurrent 5 --strategies model_pool batch
```

### é«˜çº§æµ‹è¯•
```bash
# ç”Ÿæˆå¯¹æ¯”å›¾è¡¨
python test_throughput_advanced.py --requests 50 --concurrent 5 --strategies all --plot

# ä¿å­˜è¯¦ç»†ç»“æœ
python test_throughput_advanced.py --requests 100 --concurrent 10 --strategies all --save

# å®Œæ•´æµ‹è¯•
python test_throughput_advanced.py --requests 50 --concurrent 5 --strategies all --plot --save
```

## ğŸ“Š å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | é€‰é¡¹ |
|------|------|--------|------|
| `--url` | API åŸºç¡€URL | `http://localhost:8000` | ä»»æ„URL |
| `--requests` | æ¯ä¸ªç­–ç•¥çš„è¯·æ±‚æ•°é‡ | `20` | æ­£æ•´æ•° |
| `--concurrent` | æœ€å¤§å¹¶å‘æ•° | `3` | æ­£æ•´æ•° |
| `--strategies` | æµ‹è¯•ç­–ç•¥ | `baseline` | `baseline`, `model_pool`, `batch`, `async`, `all` |
| `--plot` | ç”Ÿæˆå›¾è¡¨ | `False` | å¸ƒå°”å€¼ |
| `--save` | ä¿å­˜ç»“æœ | `False` | å¸ƒå°”å€¼ |

## ğŸ“ˆ æµ‹è¯•ç­–ç•¥è¯´æ˜

### 1. **Baseline (åŸºå‡†)**
- ä½¿ç”¨å½“å‰çš„ `/generate` ç«¯ç‚¹
- æµ‹è¯•ç°æœ‰å®ç°çš„æ€§èƒ½
- ä½œä¸ºå…¶ä»–ç­–ç•¥çš„å¯¹æ¯”åŸºå‡†

### 2. **Model Pool (æ¨¡å‹æ± )**
- å‡è®¾å®ç°äº†æ¨¡å‹æ± ä¼˜åŒ–
- æµ‹è¯•å¹¶å‘æ¨¡å‹è®¿é—®çš„æ€§èƒ½
- é¢„æœŸååé‡æå‡ 3-5x

### 3. **Batch (æ‰¹é‡æ¨ç†)**
- å‡è®¾å®ç°äº†æ‰¹é‡æ¨ç†ç«¯ç‚¹ `/batch-generate`
- æµ‹è¯•æ‰¹é‡å¤„ç†çš„æ€§èƒ½
- é¢„æœŸååé‡æå‡ 1.5-2x

### 4. **Async (å¼‚æ­¥æ¨ç†)**
- å‡è®¾å®ç°äº†å¼‚æ­¥æ¨ç†ç«¯ç‚¹ `/async-generate`
- æµ‹è¯•å¼‚æ­¥å¤„ç†çš„æ€§èƒ½
- é¢„æœŸå“åº”æ—¶é—´å‡å°‘ 30-50%

## ğŸ“‹ è¾“å‡ºç¤ºä¾‹

```
ğŸš€ FLUX API é«˜çº§ååé‡æµ‹è¯•å·¥å…·
ğŸ“ API URL: http://localhost:8000
ğŸ“Š æµ‹è¯•é…ç½®: 20 è¯·æ±‚/ç­–ç•¥, 3 å¹¶å‘
ğŸ¯ æµ‹è¯•ç­–ç•¥: ['baseline', 'model_pool', 'batch', 'async']

ğŸ“Š æµ‹è¯•åŸºå‡†ååé‡: 20 è¯·æ±‚, 3 å¹¶å‘
ğŸŠ æµ‹è¯•æ¨¡å‹æ± ä¼˜åŒ–: 20 è¯·æ±‚, 5 å¹¶å‘
ğŸ“¦ æµ‹è¯•æ‰¹é‡æ¨ç†: 20 è¯·æ±‚, 3 å¹¶å‘
âš¡ æµ‹è¯•å¼‚æ­¥æ¨ç†: 20 è¯·æ±‚, 3 å¹¶å‘

====================================================================================================
ğŸ“Š ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”æŠ¥å‘Š
====================================================================================================
ç­–ç•¥            ååé‡      æˆåŠŸç‡   å¹³å‡å“åº”æ—¶é—´   P95å“åº”æ—¶é—´   GPUåˆ©ç”¨ç‡  æ•ˆç‡åˆ†æ•°  
----------------------------------------------------------------------------------------------------
baseline       0.25        100.0%   15.23s       18.45s       45.2%      0.342     
model_pool     1.15        100.0%   12.87s       15.23s       78.5%      0.623     
batch          0.42        100.0%   13.45s       16.78s       65.3%      0.456     
async          0.28        100.0%   10.89s       13.45s       52.1%      0.478     
====================================================================================================

ğŸ† æœ€ä½³ç­–ç•¥: model_pool
   æ•ˆç‡åˆ†æ•°: 0.623
   ååé‡: 1.15 è¯·æ±‚/ç§’
   å¹³å‡å“åº”æ—¶é—´: 12.87ç§’

ğŸ“ˆ æ€§èƒ½æå‡åˆ†æ (ç›¸å¯¹äºåŸºå‡†):
   model_pool: ååé‡ +360.0%, å“åº”æ—¶é—´ -15.5%
   batch: ååé‡ +68.0%, å“åº”æ—¶é—´ -11.7%
   async: ååé‡ +12.0%, å“åº”æ—¶é—´ -28.5%
====================================================================================================
```

## ğŸ”§ è‡ªå®šä¹‰æµ‹è¯•

### ä¿®æ”¹æµ‹è¯•å‚æ•°
```python
# åœ¨ä»£ç ä¸­ä¿®æ”¹æµ‹è¯•å‚æ•°
payload = {
    "prompt": prompt,
    "num_inference_steps": 25,  # ä¿®æ”¹æ¨ç†æ­¥æ•°
    "guidance_scale": 3.5,      # ä¿®æ”¹å¼•å¯¼æ¯”ä¾‹
    "width": 512,               # ä¿®æ”¹å›¾åƒå®½åº¦
    "height": 512               # ä¿®æ”¹å›¾åƒé«˜åº¦
}
```

### æ·»åŠ æ–°çš„æµ‹è¯•ç­–ç•¥
```python
# åœ¨ AdvancedFluxTester ç±»ä¸­æ·»åŠ æ–°æ–¹æ³•
async def test_custom_throughput(self, num_requests: int, max_concurrent: int = 3):
    """æµ‹è¯•è‡ªå®šä¹‰ä¼˜åŒ–ç­–ç•¥"""
    return await self._test_with_strategy("custom", num_requests, max_concurrent)

# åœ¨ _test_single_request æ–¹æ³•ä¸­æ·»åŠ æ–°ç«¯ç‚¹
elif strategy == "custom":
    endpoint = "/custom-generate"  # è‡ªå®šä¹‰ç«¯ç‚¹
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡è¯´æ˜

### 1. **ååé‡ (Throughput)**
- å•ä½: è¯·æ±‚/ç§’
- è¡¡é‡ç³»ç»Ÿå¤„ç†èƒ½åŠ›
- è¶Šé«˜è¶Šå¥½

### 2. **å“åº”æ—¶é—´ (Response Time)**
- å¹³å‡å“åº”æ—¶é—´: æ‰€æœ‰è¯·æ±‚çš„å¹³å‡å€¼
- P95 å“åº”æ—¶é—´: 95% è¯·æ±‚çš„å“åº”æ—¶é—´
- P99 å“åº”æ—¶é—´: 99% è¯·æ±‚çš„å“åº”æ—¶é—´

### 3. **æ•ˆç‡åˆ†æ•° (Efficiency Score)**
- ç»¼åˆè€ƒè™‘ååé‡ã€å“åº”æ—¶é—´å’Œ GPU åˆ©ç”¨ç‡
- èŒƒå›´: 0-1ï¼Œè¶Šé«˜è¶Šå¥½
- è®¡ç®—å…¬å¼: `throughput_score * 0.5 + response_time_score * 0.3 + gpu_score * 0.2`

### 4. **èµ„æºåˆ©ç”¨ç‡**
- GPU åˆ©ç”¨ç‡: GPU è®¡ç®—èƒ½åŠ›ä½¿ç”¨ç™¾åˆ†æ¯”
- VRAM ä½¿ç”¨ç‡: æ˜¾å­˜ä½¿ç”¨ç™¾åˆ†æ¯”
- CPU ä½¿ç”¨ç‡: CPU ä½¿ç”¨ç™¾åˆ†æ¯”
- å†…å­˜ä½¿ç”¨ç‡: ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### åŸºäºæµ‹è¯•ç»“æœçš„ä¼˜åŒ–æ–¹å‘

1. **å¦‚æœ GPU åˆ©ç”¨ç‡ä½ (< 50%)**
   - å¢åŠ å¹¶å‘æ•°
   - å®ç°æ¨¡å‹æ± 
   - å¯ç”¨æ‰¹é‡æ¨ç†

2. **å¦‚æœå“åº”æ—¶é—´é•¿ (> 20s)**
   - å‡å°‘æ¨ç†æ­¥æ•°
   - ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
   - å®ç°å¼‚æ­¥æ¨ç†

3. **å¦‚æœ VRAM ä½¿ç”¨ç‡é«˜ (> 90%)**
   - ä¼˜åŒ–å†…å­˜ç®¡ç†
   - ä½¿ç”¨é‡åŒ–æ¨¡å‹
   - å‡å°‘æ‰¹å¤§å°

4. **å¦‚æœååé‡ä½ (< 0.5 è¯·æ±‚/ç§’)**
   - å®ç°æ¨¡å‹æ± 
   - å¢åŠ å¹¶å‘æ•°
   - ä¼˜åŒ–æ¨ç†è¿‡ç¨‹

## ğŸ“„ è¾“å‡ºæ–‡ä»¶

### JSON ç»“æœæ–‡ä»¶
```json
{
  "test_config": {
    "url": "http://localhost:8000",
    "requests_per_strategy": 20,
    "concurrent": 3,
    "strategies": ["baseline", "model_pool", "batch", "async"]
  },
  "performance_results": [...],
  "system_metrics": [...],
  "detailed_results": [...]
}
```

### å›¾è¡¨æ–‡ä»¶
- `performance_comparison.png`: æ€§èƒ½å¯¹æ¯”å›¾è¡¨
- åŒ…å«ååé‡ã€å“åº”æ—¶é—´ã€æ•ˆç‡åˆ†æ•°å’Œé›·è¾¾å›¾

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **API ç«¯ç‚¹ä¸å­˜åœ¨**
   ```bash
   # åªæµ‹è¯•åŸºå‡†ç­–ç•¥
   python test_throughput_advanced.py --strategies baseline
   ```

2. **GPU ç›‘æ§å¤±è´¥**
   ```bash
   # æ£€æŸ¥ nvidia-smi æ˜¯å¦å¯ç”¨
   nvidia-smi
   ```

3. **å†…å­˜ä¸è¶³**
   ```bash
   # å‡å°‘è¯·æ±‚æ•°é‡
   python test_throughput_advanced.py --requests 10 --concurrent 2
   ```

4. **å›¾è¡¨ç”Ÿæˆå¤±è´¥**
   ```bash
   # å®‰è£… matplotlib
   pip install matplotlib
   ```

è¿™ä¸ªé«˜çº§æµ‹è¯•å·¥å…·å¯ä»¥å¸®åŠ©ä½ å…¨é¢è¯„ä¼°ä¸åŒä¼˜åŒ–ç­–ç•¥çš„æ•ˆæœï¼Œä¸ºæ€§èƒ½ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒã€‚ 