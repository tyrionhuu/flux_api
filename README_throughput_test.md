# FLUX API ååé‡æµ‹è¯•å·¥å…·

æµ‹è¯• FLUX API çš„å¹¶å‘å¤„ç†èƒ½åŠ›å’Œå“åº”æ—¶é—´ã€‚

## å¿«é€Ÿå¼€å§‹

```bash
# å®‰è£…ä¾èµ–
pip install aiohttp

# è¿è¡Œæµ‹è¯•
python test_throughput_simple.py --requests 10 --concurrent 3
```

## å‘½ä»¤è¡Œå‚æ•°

- `--url`: API URL (é»˜è®¤: http://localhost:8000)
- `--requests`: æµ‹è¯•è¯·æ±‚æ•°é‡ (é»˜è®¤: 10)
- `--concurrent`: æœ€å¤§å¹¶å‘æ•° (é»˜è®¤: 3)
- `--test-type`: æµ‹è¯•ç±»å‹ (concurrent)
- `--save`: ä¿å­˜ç»“æœåˆ°JSONæ–‡ä»¶

## ä½¿ç”¨ç¤ºä¾‹

```bash
# åŸºæœ¬æµ‹è¯•
python test_throughput_simple.py

# é«˜è´Ÿè½½æµ‹è¯•
python test_throughput_simple.py --requests 50 --concurrent 5



# ä¿å­˜ç»“æœ
python test_throughput_simple.py --save
```

## æµ‹è¯•æŒ‡æ ‡

- ååé‡ (è¯·æ±‚/ç§’)
- å“åº”æ—¶é—´ç»Ÿè®¡
- æˆåŠŸç‡
- VRAM ä½¿ç”¨æƒ…å†µ
- ç”Ÿæˆæ—¶é—´åˆ†æ 

è¿™ä¸ªå·¥å…·ç”¨äºæµ‹è¯• FLUX API çš„å¹¶å‘å¤„ç†èƒ½åŠ›å’Œå“åº”æ—¶é—´ï¼Œå¸®åŠ©ä½ äº†è§£ç³»ç»Ÿçš„æ€§èƒ½è¡¨ç°ã€‚

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `test_throughput_fp4.py` - å®Œæ•´ç‰ˆæµ‹è¯•å·¥å…·ï¼ˆåŒ…å«å›¾è¡¨åŠŸèƒ½ï¼‰
- `test_throughput_simple.py` - ç®€åŒ–ç‰ˆæµ‹è¯•å·¥å…·ï¼ˆæ— å›¾è¡¨ä¾èµ–ï¼‰
- `README_throughput_test.md` - æœ¬è¯´æ˜æ–‡æ¡£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# å®Œæ•´ç‰ˆï¼ˆéœ€è¦matplotlibï¼‰
pip install aiohttp matplotlib numpy

# ç®€åŒ–ç‰ˆï¼ˆåªéœ€è¦aiohttpï¼‰
pip install aiohttp
```

### 2. å¯åŠ¨ FLUX API æœåŠ¡

```bash
# ç¡®ä¿ FLUX API æ­£åœ¨è¿è¡Œ
python main_fp4.py
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# ä½¿ç”¨ç®€åŒ–ç‰ˆè¿›è¡ŒåŸºæœ¬æµ‹è¯•
python test_throughput_simple.py --requests 10 --concurrent 3

# ä½¿ç”¨å®Œæ•´ç‰ˆå¹¶ç”Ÿæˆå›¾è¡¨
python test_throughput_fp4.py --requests 20 --concurrent 5 --plot

# æµ‹è¯•è¿œç¨‹æœåŠ¡å™¨
python test_throughput_simple.py --url http://your-server:8000 --requests 50
```

## ğŸ“Š æµ‹è¯•ç±»å‹

### å¹¶å‘æµ‹è¯• (Concurrent)
- åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚åˆ° `/generate` ç«¯ç‚¹
- æµ‹è¯•ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›
- ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶æœ€å¤§å¹¶å‘æ•°

## âš™ï¸ å‘½ä»¤è¡Œå‚æ•°

```bash
python test_throughput_simple.py [é€‰é¡¹]

é€‰é¡¹:
  --url URL               API åŸºç¡€URL (é»˜è®¤: http://localhost:8000)
  --requests N            æµ‹è¯•è¯·æ±‚æ•°é‡ (é»˜è®¤: 10)
  --concurrent N          æœ€å¤§å¹¶å‘æ•° (é»˜è®¤: 3)
  --test-type TYPE        æµ‹è¯•ç±»å‹: concurrent/queue/both (é»˜è®¤: both)
  --save                  ä¿å­˜è¯¦ç»†ç»“æœåˆ°JSONæ–‡ä»¶
  --plot                  ç”Ÿæˆå›¾è¡¨ (ä»…å®Œæ•´ç‰ˆ)
```

## ğŸ“ˆ æµ‹è¯•æŒ‡æ ‡

### æ ¸å¿ƒæŒ‡æ ‡
- **ååé‡**: æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•° (requests/second)
- **å“åº”æ—¶é—´**: ä»å‘é€è¯·æ±‚åˆ°æ”¶åˆ°å“åº”çš„æ€»æ—¶é—´
- **ç”Ÿæˆæ—¶é—´**: æ¨¡å‹å®é™…ç”Ÿæˆå›¾åƒçš„æ—¶é—´
- **æˆåŠŸç‡**: æˆåŠŸå®Œæˆçš„è¯·æ±‚ç™¾åˆ†æ¯”

### ç»Ÿè®¡æŒ‡æ ‡
- å¹³å‡å“åº”æ—¶é—´
- ä¸­ä½æ•°å“åº”æ—¶é—´
- æœ€å°/æœ€å¤§å“åº”æ—¶é—´
- å“åº”æ—¶é—´æ ‡å‡†å·®
- VRAM ä½¿ç”¨æƒ…å†µ

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# æµ‹è¯•ä¸åŒå¹¶å‘æ•°çš„æ€§èƒ½
python test_throughput_simple.py --requests 50 --concurrent 1
python test_throughput_simple.py --requests 50 --concurrent 3
python test_throughput_simple.py --requests 50 --concurrent 5
```

### 2. è´Ÿè½½æµ‹è¯•
```bash
# é«˜è´Ÿè½½æµ‹è¯•
python test_throughput_simple.py --requests 100 --concurrent 10 --save
```



### 3. è¿œç¨‹æœåŠ¡å™¨æµ‹è¯•
```bash
# æµ‹è¯•è¿œç¨‹éƒ¨ç½²çš„API
python test_throughput_simple.py --url http://your-server:8000 --requests 20
```

## ğŸ“‹ è¾“å‡ºç¤ºä¾‹

```
ğŸš€ FLUX API ååé‡æµ‹è¯•å·¥å…· (ç®€åŒ–ç‰ˆ)
ğŸ“ API URL: http://localhost:8000
ğŸ“Š æµ‹è¯•é…ç½®: 10 è¯·æ±‚, 3 å¹¶å‘
ğŸ¯ æµ‹è¯•ç±»å‹: both

ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...
æ¨¡å‹çŠ¶æ€: True
GPU ä¿¡æ¯: {'gpu_count': 1, 'gpu_0': {...}}
é˜Ÿåˆ—ç»Ÿè®¡: {'queue_size': 0, 'processing': 0}

ğŸ”„ å¼€å§‹å¹¶å‘æµ‹è¯•...
ğŸš€ å¼€å§‹å¹¶å‘æµ‹è¯•: 10 ä¸ªè¯·æ±‚, æœ€å¤§å¹¶å‘æ•°: 3

============================================================
ğŸ“Š å¹¶å‘è¯·æ±‚ æµ‹è¯•æŠ¥å‘Š
============================================================
ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:
   æ€»è¯·æ±‚æ•°: 10
   æˆåŠŸè¯·æ±‚: 10
   å¤±è´¥è¯·æ±‚: 0
   æˆåŠŸç‡: 100.00%
   æ€»è€—æ—¶: 45.23ç§’
   ååé‡: 0.22 è¯·æ±‚/ç§’

â±ï¸  å“åº”æ—¶é—´:
   å¹³å‡å“åº”æ—¶é—´: 13.45ç§’
   ä¸­ä½æ•°å“åº”æ—¶é—´: 12.87ç§’
   æœ€å°å“åº”æ—¶é—´: 11.23ç§’
   æœ€å¤§å“åº”æ—¶é—´: 18.92ç§’
   å“åº”æ—¶é—´æ ‡å‡†å·®: 2.34ç§’

ğŸ¨ ç”Ÿæˆæ—¶é—´:
   å¹³å‡ç”Ÿæˆæ—¶é—´: 12.89ç§’
   ä¸­ä½æ•°ç”Ÿæˆæ—¶é—´: 12.45ç§’
============================================================

ğŸ“‹ æµ‹è¯•ç»“æœæ±‡æ€»è¡¨
================================================================================
è¯·æ±‚ID    çŠ¶æ€     å“åº”æ—¶é—´(s)   ç”Ÿæˆæ—¶é—´(s)   VRAMä½¿ç”¨    
================================================================================
req_0000  âœ…      13.45        12.89        8.5GB        
req_0001  âœ…      12.87        12.45        8.5GB        
req_0002  âœ…      14.23        13.67        8.5GB        
...
================================================================================
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰æµ‹è¯•å‚æ•°
ä½ å¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„æµ‹è¯•å‚æ•°ï¼š

```python
# åœ¨ test_single_request æ–¹æ³•ä¸­ä¿®æ”¹
payload = {
    "prompt": prompt,
    "num_inference_steps": 25,  # ä¿®æ”¹æ¨ç†æ­¥æ•°
    "guidance_scale": 3.5,      # ä¿®æ”¹å¼•å¯¼æ¯”ä¾‹
    "width": 512,               # ä¿®æ”¹å›¾åƒå®½åº¦
    "height": 512               # ä¿®æ”¹å›¾åƒé«˜åº¦
}
```

### è‡ªå®šä¹‰æç¤ºè¯
ä¿®æ”¹ `test_prompts` åˆ—è¡¨æ¥ä½¿ç”¨ä¸åŒçš„æµ‹è¯•æç¤ºè¯ï¼š

```python
self.test_prompts = [
    "ä½ çš„è‡ªå®šä¹‰æç¤ºè¯1",
    "ä½ çš„è‡ªå®šä¹‰æç¤ºè¯2",
    # ...
]
```

## ğŸ“Š ç»“æœåˆ†æ

### æ€§èƒ½è¯„ä¼°æ ‡å‡†
- **ä¼˜ç§€**: ååé‡ > 0.5 è¯·æ±‚/ç§’ï¼ŒæˆåŠŸç‡ > 95%
- **è‰¯å¥½**: ååé‡ 0.2-0.5 è¯·æ±‚/ç§’ï¼ŒæˆåŠŸç‡ > 90%
- **ä¸€èˆ¬**: ååé‡ < 0.2 è¯·æ±‚/ç§’ï¼ŒæˆåŠŸç‡ > 80%

### ä¼˜åŒ–å»ºè®®
1. **ä½ååé‡**: è€ƒè™‘å¢åŠ  GPU æ•°é‡æˆ–ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
2. **é«˜å“åº”æ—¶é—´**: æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿæˆ–æ¨¡å‹åŠ è½½çŠ¶æ€
3. **é«˜å¤±è´¥ç‡**: æ£€æŸ¥ç³»ç»Ÿèµ„æºæˆ–æ¨¡å‹é…ç½®
4. **VRAM ä¸è¶³**: è€ƒè™‘ä½¿ç”¨é‡åŒ–æ¨¡å‹æˆ–å‡å°‘å¹¶å‘æ•°

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥è¶…æ—¶**
   ```bash
   # å¢åŠ è¶…æ—¶æ—¶é—´
   timeout=aiohttp.ClientTimeout(total=600)  # 10åˆ†é’Ÿ
   ```

2. **å†…å­˜ä¸è¶³**
   ```bash
   # å‡å°‘å¹¶å‘æ•°
   python test_throughput_simple.py --concurrent 1
   ```

3. **API æœªå“åº”**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   curl http://localhost:8000/health
   ```

4. **å›¾è¡¨æ˜¾ç¤ºé—®é¢˜**
   ```bash
   # ä½¿ç”¨ç®€åŒ–ç‰ˆ
   python test_throughput_simple.py --requests 10
   ```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export PYTHONPATH=.
python -u test_throughput_simple.py --requests 5 --concurrent 1
```

## ğŸ“„ è¾“å‡ºæ–‡ä»¶

### JSON ç»“æœæ–‡ä»¶
ä½¿ç”¨ `--save` å‚æ•°ä¼šç”ŸæˆåŒ…å«è¯¦ç»†æµ‹è¯•æ•°æ®çš„ JSON æ–‡ä»¶ï¼š

```json
{
  "test_config": {
    "url": "http://localhost:8000",
    "requests": 10,
    "concurrent": 3,
    "test_type": "both"
  },
  "system_status": {
    "model_status": {...},
    "gpu_info": {...},
    "queue_stats": {...}
  },
  "test_results": [
    {
      "request_id": "req_0000",
      "start_time": 1234567890.123,
      "end_time": 1234567903.456,
      "response_time": 13.333,
      "status_code": 200,
      "success": true,
      "generation_time": 12.89,
      "vram_usage": "8.5GB"
    }
  ]
}
```

### å›¾è¡¨æ–‡ä»¶ (ä»…å®Œæ•´ç‰ˆ)
ä½¿ç”¨ `--plot` å‚æ•°ä¼šç”Ÿæˆæ€§èƒ½åˆ†æå›¾è¡¨ï¼š
- `throughput_test_results.png` - åŒ…å«å“åº”æ—¶é—´åˆ†å¸ƒã€ç”Ÿæˆæ—¶é—´åˆ†å¸ƒã€è¯·æ±‚æ—¶é—´çº¿å’Œå®æ—¶ååé‡

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªæµ‹è¯•å·¥å…·ï¼

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚ 
 